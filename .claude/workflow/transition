#!/bin/bash
# State Transition Command
# Usage: .claude/workflow/transition <task-id> <from-state> <to-state>
#
# Validates state transitions and updates ACTIVE.md programmatically
# This enforces the state machine deterministically

set -e

TASK_ID="$1"
FROM_STATE="$2"
TO_STATE="$3"
ACTIVE_FILE=".claude/state/ACTIVE.md"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Validation
if [ -z "$TASK_ID" ] || [ -z "$FROM_STATE" ] || [ -z "$TO_STATE" ]; then
    echo -e "${RED}‚ùå Usage: .claude/workflow/transition <task-id> <from-state> <to-state>${NC}"
    echo ""
    echo "Example: .claude/workflow/transition TASK-001 UNCLAIMED IN_PROGRESS"
    echo ""
    echo "Valid states: UNCLAIMED, IN_PROGRESS, IN_REVIEW, ADDRESSING_FEEDBACK, COMPLETED"
    exit 1
fi

# Validate transition
validate_transition() {
    local from="$1"
    local to="$2"

    case "$from-$to" in
        "UNCLAIMED-IN_PROGRESS")
            return 0
            ;;
        "IN_PROGRESS-IN_REVIEW")
            return 0
            ;;
        "IN_REVIEW-COMPLETED")
            return 0
            ;;
        "IN_REVIEW-ADDRESSING_FEEDBACK")
            return 0
            ;;
        "ADDRESSING_FEEDBACK-IN_REVIEW")
            return 0
            ;;
        *)
            return 1
            ;;
    esac
}

# Check if transition is valid
if ! validate_transition "$FROM_STATE" "$TO_STATE"; then
    echo -e "${RED}‚ùå INVALID TRANSITION: $FROM_STATE ‚Üí $TO_STATE${NC}"
    echo ""
    echo "Valid transitions:"
    echo "  UNCLAIMED ‚Üí IN_PROGRESS"
    echo "  IN_PROGRESS ‚Üí IN_REVIEW"
    echo "  IN_REVIEW ‚Üí COMPLETED"
    echo "  IN_REVIEW ‚Üí ADDRESSING_FEEDBACK"
    echo "  ADDRESSING_FEEDBACK ‚Üí IN_REVIEW"
    echo ""
    exit 1
fi

# Check if ACTIVE.md exists
if [ ! -f "$ACTIVE_FILE" ]; then
    echo -e "${RED}‚ùå ACTIVE.md not found at $ACTIVE_FILE${NC}"
    exit 1
fi

# Perform the transition
echo -e "${YELLOW}üîÑ Transitioning $TASK_ID: $FROM_STATE ‚Üí $TO_STATE${NC}"
echo ""

# Move task between sections in ACTIVE.md
# This is a simplified implementation - in practice, you'd parse and update the markdown
# For now, we'll use sed to update the state field

# Check if task exists
if ! grep -q "\[$TASK_ID\]" "$ACTIVE_FILE"; then
    echo -e "${RED}‚ùå Task $TASK_ID not found in ACTIVE.md${NC}"
    exit 1
fi

# Verify task is actually in FROM_STATE
# Extract the task block and check its current state
TASK_BLOCK=$(sed -n "/\[$TASK_ID\]/,/^$/p" "$ACTIVE_FILE")
if ! echo "$TASK_BLOCK" | grep -q "State: \`$FROM_STATE\`"; then
    CURRENT_STATE=$(echo "$TASK_BLOCK" | grep -oP 'State: `\K\w+' | head -1)
    echo -e "${RED}‚ùå STATE MISMATCH${NC}"
    echo ""
    echo "Task $TASK_ID is currently in state: ${YELLOW}$CURRENT_STATE${NC}"
    echo "You specified FROM_STATE: ${YELLOW}$FROM_STATE${NC}"
    echo ""
    echo "Cannot transition from $FROM_STATE (task is not in that state)"
    echo ""
    echo "Valid transitions from ${YELLOW}$CURRENT_STATE${NC}:"
    case "$CURRENT_STATE" in
        "UNCLAIMED")
            echo "  ‚Üí IN_PROGRESS (spawn worker agent)"
            ;;
        "IN_PROGRESS")
            echo "  ‚Üí IN_REVIEW (implementation complete, spawn reviewers)"
            ;;
        "IN_REVIEW")
            echo "  ‚Üí COMPLETED (all reviews approved)"
            echo "  ‚Üí ADDRESSING_FEEDBACK (changes requested)"
            ;;
        "ADDRESSING_FEEDBACK")
            echo "  ‚Üí IN_REVIEW (fixes complete, re-review)"
            ;;
        "COMPLETED")
            echo "  (No transitions from COMPLETED - task is done)"
            ;;
        *)
            echo "  (Unknown state: $CURRENT_STATE)"
            ;;
    esac
    echo ""
    exit 1
fi

# All validations passed - perform the transition
# Create a backup
cp "$ACTIVE_FILE" "${ACTIVE_FILE}.bak"

# Step 1: Update the state field in the task block
sed -i "/\[$TASK_ID\]/,/^$/s/- State: \`$FROM_STATE\`/- State: \`$TO_STATE\`/" "$ACTIVE_FILE"

# Step 2: Move task block to appropriate section using Python helper
SCRIPT_DIR="$(dirname "$0")"
if ! python3 "$SCRIPT_DIR/move_task.py" "$ACTIVE_FILE" "$TASK_ID" "$FROM_STATE" "$TO_STATE"; then
    echo -e "${RED}‚ùå Failed to move task block${NC}"
    echo "Restoring backup..."
    mv "${ACTIVE_FILE}.bak" "$ACTIVE_FILE"
    exit 1
fi

# Cleanup backup
rm -f "${ACTIVE_FILE}.bak"

echo -e "${GREEN}‚úÖ State transition complete${NC}"
echo ""
echo "Task $TASK_ID successfully moved:"
case "$TO_STATE" in
    "IN_PROGRESS")
        echo "  ‚Üí Now in 'üî® IN PROGRESS' section"
        ;;
    "IN_REVIEW")
        echo "  ‚Üí Now in 'üîç IN REVIEW' section"
        ;;
    "ADDRESSING_FEEDBACK")
        echo "  ‚Üí Now in 'üîß ADDRESSING_FEEDBACK' section"
        ;;
    "COMPLETED")
        echo "  ‚Üí Now in '‚úÖ RECENTLY COMPLETED' section"
        ;;
esac
echo ""
echo "Next steps:"
echo "  1. Review the changes in $ACTIVE_FILE"
echo "  2. Commit the transition:"
echo "     git add $ACTIVE_FILE"
echo "     git commit -m \"[workflow] $TASK_ID: $FROM_STATE ‚Üí $TO_STATE\""
echo ""

exit 0
